<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>map</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.16.1/mapbox-gl.js"></script>
</head>

<body>
    <header>
        <h1 class="ceiheader">
            Chiangrai Suicide Risk Data
        </h1>
        <div class="top-buttons">
            <button class="top-buttons-information" onclick="window.location.href='/upload'">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="top-buttons-information logout" onclick="logout()">Logout</button>
        </div>
    </header>


    <div class="container">

        <div class="sidebar">


            <div class="info-box">
                <div class="info-box-person">
                    <p id="summary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏<br><strong id="total-events">-</strong></h3>
                </div>
                <div id="detail-summary"></div>
            </div>



            <form class="selectors" id="filterForm">
                <label for="year" class="all-label">‡∏õ‡∏µ</label>
                <select id="year" name="year">
                </select>

                <label for="month" class="all-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                <select id="month" name="month">

                </select>

                <label for="date" class="all-label">‡∏ß‡∏±‡∏ô</label>
                <select id="date" name="date">

                </select>

                <label for="district" class="all-label">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                <select id="district" name="district">
                    <option>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
                </select>

                <label for="subdistrict" class="all-label">‡∏ï‡∏≥‡∏ö‡∏•</label>
                <select id="subdistrict" name="subdistrict">
                    <option>‡∏ï‡∏≥‡∏ö‡∏•</option>
                </select>



                <div style="width: 100%; margin-top: 10px;">
                    <b>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</b>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="income" value="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ" />‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</label>
                        <label><input type="checkbox" name="income" value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢" />‡∏ô‡πâ‡∏≠‡∏¢</label>
                        <label><input type="checkbox" name="income" value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å" />‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å</label>
                        <label><input type="checkbox" name="income" value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á" />‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</label>
                        <label><input type="checkbox" name="income"
                                value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡πà‡∏≠‡∏ô‡∏™‡∏π‡∏á" />‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡πà‡∏≠‡∏ô‡∏™‡∏π‡∏á</label>
                        <label><input type="checkbox" name="income" value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á" />‡∏™‡∏π‡∏á</label>
                        <label><input type="checkbox" name="income" value="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å" />‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å</label>
                    </div>
                </div>

                <div style="width: 100%; margin-top: 10px;">
                    <b>‡∏≠‡∏≤‡∏¢‡∏∏</b>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="ageGroups" value="‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏" />‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</label>
                        <label><input type="checkbox" name="ageGroups" value="‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á" />‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á</label>
                        <label><input type="checkbox" name="ageGroups" value="‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô" />‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô</label>
                        <label><input type="checkbox" name="ageGroups" value="‡πÄ‡∏î‡πá‡∏Å" />‡πÄ‡∏î‡πá‡∏Å</label>
                    </div>
                </div>

                <div style="width: 100%; margin-top: 10px;">
                    <b>‡πÄ‡∏û‡∏®</b>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="gender" value="‡∏ä‡∏≤‡∏¢" />‡∏ä‡∏≤‡∏¢</label>
                        <label><input type="checkbox" name="gender" value="‡∏´‡∏ç‡∏¥‡∏á" />‡∏´‡∏ç‡∏¥‡∏á</label>
                    </div>
                </div>

                <div style="width: 100%; margin-top: 10px;">
                    <b>‡∏§‡∏î‡∏π</b>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="season" value="‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô" /> ‡∏§‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô</label>
                        <label><input type="checkbox" name="season" value="‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß" /> ‡∏§‡∏î‡∏π‡∏´‡∏ô‡∏≤‡∏ß</label>
                        <label><input type="checkbox" name="season" value="‡∏§‡∏î‡∏π‡∏ù‡∏ô" /> ‡∏§‡∏î‡∏π‡∏ù‡∏ô</label>
                    </div>
                </div>

            </form>
            <div class="button-container">
                <div>
                    <button id="map-button" onclick="window.location.href='/index'">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
                </div>
                <div>
                    <button id="graph-button" onclick="window.location.href='/chart'">‡∏Å‡∏£‡∏≤‡∏ü</button>
                </div>
                <div>
                    <button id="table-button" onclick="window.location.href='/table'">‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                </div>
            </div>




        </div>

        <div id="map"></div>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

        <script>
            const map = L.map('map').setView([19.9, 99.8], 9);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // normalize function: trim space ‡πÅ‡∏•‡∏∞ invisible char
            function normalizeName(name) {
                return name ? name.trim() : '';
            }
            let currentLevel = 'district';
            let currentDistrict = null;
            const levelControl = L.control({ position: 'topright' });

            levelControl.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'level-control');
                div.style.background = 'white';
                div.style.padding = '6px';
                div.style.borderRadius = '4px';
                div.style.cursor = 'pointer';
                div.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
                div.innerHTML = '<b>‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</b>';

                div.onclick = function () {
                    if (currentLevel === 'subdistrict') {
                        // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
                        loadInitialData();
                    }
                };

                return div;
            };



            const legend = L.control({ position: 'bottomleft' });

            legend.onAdd = function (map) {

                const detail = L.DomUtil.create('detail', 'legend');
                detail.innerHTML = `
                <b>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</b><br>
                <i style="background:#e74c3c"></i> ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏π‡∏á<br>
                <i style="background:#f39c12"></i> ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á<br>
                <i style="background:#16a085"></i> ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡πà‡∏≥<br>
                <i style="background:#bdc3c7"></i> ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏<br>
                                                            `;
                return detail;
            };
            legend.addTo(map);
            levelControl.addTo(map);
            //-----------------------------------------------------select years---------------------------------------
            async function loadYearOptions(filter) {
                let url = 'http://localhost:3000/api/options/year';
                const params = [];
                if (filter.month) params.push(`month=${encodeURIComponent(filter.month)}`);
                if (filter.day) params.push(`day=${encodeURIComponent(filter.day)}`);
                if (params.length) url += '?' + params.join('&');

                const res = await fetch(url);
                const years = await res.json();
                const select = document.getElementById('year');
                const oldValue = select.value;

                select.innerHTML = '<option value="">‡∏õ‡∏µ</option>';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                });

                if (oldValue && years.includes(parseInt(oldValue))) select.value = oldValue;
                else select.value = '';
            }

            //-----------------------------------------------------select month---------------------------------------
            async function loadMonthOptions(filter) {
                let url = 'http://localhost:3000/api/options/month';
                const params = [];
                if (filter.year) params.push(`year=${encodeURIComponent(filter.year)}`);
                if (filter.day) params.push(`day=${encodeURIComponent(filter.day)}`);
                if (params.length) url += '?' + params.join('&');

                const res = await fetch(url);
                const months = await res.json();
                const select = document.getElementById('month');
                const oldValue = select.value;

                select.innerHTML = '<option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>';
                const monthMap = {
                    1: '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', 2: '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', 3: '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', 4: '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô',
                    5: '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', 6: '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', 7: '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', 8: '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°',
                    9: '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', 10: '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', 11: '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', 12: '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                };
                months.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = monthMap[m];
                    select.appendChild(option);
                });

                if (oldValue && months.includes(parseInt(oldValue))) select.value = oldValue;
                else select.value = '';
            }




            //-----------------------------------------------------select date---------------------------------------
            async function loadDayOptions(filter) {
                let url = 'http://localhost:3000/api/options/day';
                const params = [];
                if (filter.year) params.push(`year=${encodeURIComponent(filter.year)}`);
                if (filter.month) params.push(`month=${encodeURIComponent(filter.month)}`);
                if (params.length) url += '?' + params.join('&');

                const res = await fetch(url);
                const days = await res.json();
                const select = document.getElementById('date');
                const oldValue = select.value;

                select.innerHTML = '<option value="">‡∏ß‡∏±‡∏ô</option>';
                days.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d;
                    option.textContent = d;
                    select.appendChild(option);
                });

                if (oldValue && days.includes(parseInt(oldValue))) select.value = oldValue;
                else select.value = '';
            }


            //-----------------------------------------------------select district---------------------------------------

            async function loadDistrictOptions() {
                try {
                    const res = await fetch('http://localhost:3000/api/options/district');
                    const districts = await res.json();

                    const select = document.getElementById('district');
                    const oldValue = select.value; // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°

                    select.innerHTML = '<option value="none">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>';

                    districts.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });

                    if (oldValue && districts.includes(oldValue)) {
                        select.value = oldValue;
                        document.getElementById('subdistrict').disabled = false;
                    } else {
                        select.value = 'none';
                        const sub = document.getElementById('subdistrict');
                        sub.innerHTML = '<option value="none">‡∏ï‡∏≥‡∏ö‡∏•</option>';
                        sub.disabled = true;
                    }
                } catch (err) {
                    console.error('‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
                }
            }


            // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡∏ö‡∏• ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
            document.getElementById('district').addEventListener('change', async (e) => {
                const districtName = e.target.value;

                if (!districtName || districtName === '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' || districtName === 'none') {
                    document.getElementById('subdistrict').innerHTML = '<option value="none">‡∏ï‡∏≥‡∏ö‡∏•</option>';
                    document.getElementById('subdistrict').disabled = true; // ‚úÖ ‡∏õ‡∏¥‡∏î
                    updateMap();
                    return;
                }

                try {
                    const res = await fetch(`http://localhost:3000/api/options/subdistrict?districtName=${encodeURIComponent(districtName)}`);
                    const data = await res.json();

                    const select = document.getElementById('subdistrict');
                    select.innerHTML = '<option value="">‡∏ï‡∏≥‡∏ö‡∏•</option>';

                    data.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });

                    select.disabled = false; // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à

                    updateMap();
                } catch (err) {
                    console.error('‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡∏ö‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', err);
                }
            });

            async function zoomToSubdistrict(districtName, subdistrictName) {
                const payload = {
                    districtName,
                    incomeLevels: [...document.querySelectorAll('input[name="income"]:checked')].map(cb => cb.value),
                    genders: [...document.querySelectorAll('input[name="gender"]:checked')].map(cb => cb.value),
                    ageGroups: [...document.querySelectorAll('input[name="ageGroups"]:checked')].map(cb => cb.value),
                    seasons: [...document.querySelectorAll('input[name="season"]:checked')].map(cb => cb.value),
                };

                const year = document.getElementById('year').value;
                const month = document.getElementById('month').value;
                const date = document.getElementById('date').value;
                if (year) payload.year = parseInt(year);
                if (month) payload.month = parseInt(month);
                if (date) payload.date = parseInt(date);

                const res = await fetch(`http://localhost:3000/subdistrict-map-data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (!window.geoLayer) {
                    window.geoLayer = L.layerGroup().addTo(map);
                } else {
                    window.geoLayer.clearLayers();
                }


                window.geoLayer = L.geoJSON(data.features, {
                    style: feature => {
                        const subdistrict = normalizeName(feature.properties.tam_th);
                        const risk = data.riskBySubdistrict[subdistrict] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        return {
                            fillColor: getColor(risk),
                            weight: 1,
                            color: 'white',
                            fillOpacity: 0.6
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const subdistrict = normalizeName(feature.properties.tam_th);
                        const risk = data.riskBySubdistrict[subdistrict] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        const counts = data.subdistrictStats?.[subdistrict];
                        const detail = counts ? `<br>‡∏ï‡πà‡∏≥: ${counts.low} ‡∏Å‡∏•‡∏≤‡∏á: ${counts.medium} ‡∏™‡∏π‡∏á: ${counts.high}` : '';
                        layer.bindPopup(`<b>‡∏ï‡∏≥‡∏ö‡∏•:</b> ${subdistrict}<br><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</b> ${risk}${detail}`);

                        // ‚úÖ ‡∏ã‡∏π‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        if (subdistrict === normalizeName(subdistrictName)) {
                            const bounds = layer.getBounds();
                            map.fitBounds(bounds);
                            // layer.openPopup();
                        }
                    }
                }).addTo(map);

                levelControl.getContainer().innerHTML = `<b>‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏ï‡∏≥‡∏ö‡∏• (${districtName})</b>`;
                currentLevel = 'subdistrict';
                currentDistrict = districtName;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° event ‡πÉ‡∏´‡πâ subdistrict ‡∏î‡πâ‡∏ß‡∏¢
            document.getElementById('subdistrict').addEventListener('change', async () => {
                const district = document.getElementById('district').value;
                const subdistrict = document.getElementById('subdistrict').value;
                if (district && subdistrict) {
                    await zoomToSubdistrict(district, subdistrict);
                } else {
                    updateMap(); // fallback ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
                }
            });

            async function updateDateDropdowns() {
                const filter = {
                    year: document.getElementById('year').value || null,
                    month: document.getElementById('month').value || null,
                    day: document.getElementById('date').value || null
                };

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î dropdown ‡∏ó‡∏±‡πâ‡∏á 3 ‡∏ï‡∏±‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                await Promise.all([
                    loadYearOptions(filter),
                    loadMonthOptions(filter),
                    loadDayOptions(filter),
                    loadDistrictOptions()
                ]);

                // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ï‡∏≤‡∏° filter ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                updateMap();
            }
            ['year', 'month', 'date'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('change', () => {
                    updateDateDropdowns();
                });
            });




            window.addEventListener('DOMContentLoaded', () => {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å load dropdown ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                updateDateDropdowns();

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° listener ‡πÉ‡∏´‡πâ dropdown ‡∏ó‡∏±‡πâ‡∏á 3
                ['year', 'month', 'date'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', () => {
                            updateDateDropdowns();
                        });
                    }
                });
            });






            //----------------------------------------------load map -------------------------------------------------------
            async function loadInitialData() {
                const res = await fetch('http://localhost:3000/map-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await res.json();
                console.log('Initial load:', data);

                currentLevel = 'district';
                currentDistrict = null;
                levelControl.getContainer().innerHTML = '<b>‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</b>';

                drawGeoLayer(data);
            }

            //------------------------------------------------check box--------------------------------------------------------------------
            const filterInputs = document.querySelectorAll('input[name="income"], input[name="gender"], input[name="ageGroups"], input[name="season"]');

            async function updateMap() {
                const payload = {};

                const incomeLevels = [...document.querySelectorAll('input[name="income"]:checked')].map(cb => cb.value);
                const genders = [...document.querySelectorAll('input[name="gender"]:checked')].map(cb => cb.value);
                const ageGroups = [...document.querySelectorAll('input[name="ageGroups"]:checked')].map(cb => cb.value);
                const seasons = [...document.querySelectorAll('input[name="season"]:checked')].map(cb => cb.value);

                payload.incomeLevels = incomeLevels;
                payload.genders = genders;
                payload.ageGroups = ageGroups;
                payload.seasons = seasons;

                const year = document.getElementById('year').value;
                const month = document.getElementById('month').value;
                const date = document.getElementById('date').value;
                const district = document.getElementById('district').value;
                const subdistrict = document.getElementById('subdistrict').value;
                if (year) payload.year = parseInt(year);
                if (month) payload.month = parseInt(month);
                if (date) payload.date = parseInt(date);
                if (district) payload.district = district;
                if (subdistrict) payload.subdistrict = subdistrict;
                console.log('Payload:', payload);

                try {
                    const res = await fetch('http://localhost:3000/map-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    console.log('Filter changed:', data);

                    drawGeoLayer(data);
                } catch (error) {
                    console.error('Error fetching map data:', error);
                }
            }

            document.getElementById('district').addEventListener('change', async (e) => {
                const districtName = e.target.value;
                const res = await fetch(`http://localhost:3000/api/options/subdistrict?districtName=${encodeURIComponent(districtName)}`);
                const data = await res.json();
                const select = document.getElementById('subdistrict');

                select.innerHTML = `<option value="">‡∏ï‡∏≥‡∏ö‡∏•</option>`;
                data.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
            });
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° event change ‡πÉ‡∏´‡πâ checkbox + select
            filterInputs.forEach(input => {
                input.addEventListener('change', updateMap);
            });



            function drawGeoLayer(data) {
                if (!window.geoLayer) {
                    window.geoLayer = L.layerGroup().addTo(map);
                } else {
                    window.geoLayer.clearLayers();
                }


                console.log('District keys:', Object.keys(data.riskByDistrict));

                window.geoLayer = L.geoJSON(data.geojson, {
                    style: feature => {
                        const district = normalizeName(feature.properties.amp_th);
                        const risk = data.riskByDistrict[district] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        console.log(`District: ${district}, Risk: ${risk}`);

                        return {
                            fillColor: getColor(risk),
                            weight: 2,
                            color: 'white',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const district = normalizeName(feature.properties.amp_th);
                        const risk = data.riskByDistrict[district] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

                        const counts = data.districtStats ? data.districtStats[district] : null; // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ
                        const detail = counts ? `<br>‡∏ï‡πà‡∏≥ : ${counts.low} ‡∏Å‡∏•‡∏≤‡∏á : ${counts.medium} ‡∏™‡∏π‡∏á : ${counts.high}` : '';

                        layer.bindPopup(`<b>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</b> ${district}<br><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö : </b> ${risk}${detail}`);
                        layer.on('mouseover', function (e) {
                            this.openPopup();
                            // ‡πÄ‡∏û‡∏¥‡πà‡∏° cursor pointer ‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö
                            this._path.style.cursor = 'pointer';
                        });
                        // ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° ‡πÉ‡∏ä‡πâ click ‡∏ó‡∏±‡πâ‡∏á layer ‡πÄ‡∏•‡∏¢:
                        layer.on('click', () => {
                            currentLevel = 'subdistrict';
                            currentDistrict = district;
                            loadSubdistrict(district);

                            const bounds = layer.getBounds();
                            map.fitBounds(bounds); // Zoom ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
                        });


                        async function loadSubdistrict(districtName) {
                            console.log('‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡∏≠‡∏á:', districtName);

                            // üëá ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡∏à‡∏≤‡∏Å checkbox ‡πÅ‡∏•‡∏∞ dropdown
                            const incomeLevels = [...document.querySelectorAll('input[name="income"]:checked')].map(cb => cb.value);
                            const genders = [...document.querySelectorAll('input[name="gender"]:checked')].map(cb => cb.value);
                            const ageGroups = [...document.querySelectorAll('input[name="ageGroups"]:checked')].map(cb => cb.value);
                            const seasons = [...document.querySelectorAll('input[name="season"]:checked')].map(cb => cb.value);

                            const year = document.getElementById('year').value;
                            const month = document.getElementById('month').value;
                            const date = document.getElementById('date').value;

                            const payload = {
                                districtName,
                                incomeLevels,
                                genders,
                                ageGroups,
                                seasons,
                            };

                            if (year) payload.year = parseInt(year);
                            if (month) payload.month = parseInt(month);
                            if (date) payload.date = parseInt(date);

                            const res = await fetch(`http://localhost:3000/subdistrict-map-data`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            const data = await res.json();

                            if (!window.geoLayer) {
                                window.geoLayer = L.layerGroup().addTo(map);
                            } else {
                                window.geoLayer.clearLayers();
                            }

                            window.geoLayer = L.geoJSON(data.features, {
                                style: feature => {
                                    const subdistrictName = normalizeName(feature.properties.tam_th);
                                    const risk = data.riskBySubdistrict[subdistrictName] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

                                    return {
                                        fillColor: getColor(risk),
                                        weight: 1,
                                        color: 'white',
                                        fillOpacity: 0.6
                                    };
                                },
                                onEachFeature: (feature, layer) => {
                                    const subdistrictName = normalizeName(feature.properties.tam_th);
                                    const risk = data.riskBySubdistrict[subdistrictName] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                                    const counts = data.subdistrictStats ? data.subdistrictStats[subdistrictName] : null;
                                    const detail = counts ? `<br>‡∏ï‡πà‡∏≥: ${counts.low} ‡∏Å‡∏•‡∏≤‡∏á: ${counts.medium} ‡∏™‡∏π‡∏á: ${counts.high}` : '';

                                    layer.bindPopup(`<b>‡∏ï‡∏≥‡∏ö‡∏•:</b> ${subdistrictName}<br><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</b> ${risk}${detail}`);
                                }
                            }).addTo(map);

                            const bounds = window.geoLayer.getBounds();
                            map.fitBounds(bounds);

                            currentLevel = 'subdistrict';
                            currentDistrict = districtName;
                            levelControl.getContainer().innerHTML = `<b>‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡∏ï‡∏≥‡∏ö‡∏• (${districtName})</b>`;
                        }



                    }

                }).addTo(map);
                // Update sidebar summary
                document.getElementById('summary').innerText = `‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡πà‡∏≥ : ${data.total.low}\n‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á : ${data.total.medium}\n‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏π‡∏á : ${data.total.high}`;
                document.getElementById('total-events').innerText =
                    data.total.low + data.total.medium + data.total.high;
            }
            function getColor(risk) {
                if (risk === '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏π‡∏á') return '#e74c3c';
                if (risk === '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏•‡∏≤‡∏á') return '#f39c12';
                if (risk === '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡πà‡∏≥') return '#16a085';
                return '#bdc3c7';
            }


            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
            loadInitialData();
            async function logout() {
                const res = await fetch('/logout', { method: 'POST' });
                if (res.ok) {
                    window.location.href = '/login';
                }
            }
            window.addEventListener('pageshow', function (event) {
                if (event.persisted || window.performance.navigation.type === 2) {
                    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å cache
                    window.location.reload();
                }
            });
        </script>

    </div>

</body>

</html>